<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pokémon Search (Static)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 1rem;
    }
    img {
      max-width: 150px;
    }
    .loading {
      font-weight: bold;
      color: blue;
    }
    #result {
      margin-top: 1rem;
      border-top: 1px solid #ccc;
      padding-top: 1rem;
    }
  </style>
</head>
<body>

  <h1>Pokémon Search</h1>

  <form id="search-form">
    <label for="poke-type">Pokémon Type:</label>
    <select id="poke-type" name="type">
      <option value="">--Any--</option>
      <option value="normal">Normal</option>
      <option value="fire">Fire</option>
      <option value="water">Water</option>
      <option value="electric">Electric</option>
      <option value="grass">Grass</option>
      <option value="ice">Ice</option>
      <option value="fighting">Fighting</option>
      <option value="poison">Poison</option>
      <option value="ground">Ground</option>
      <option value="flying">Flying</option>
      <option value="psychic">Psychic</option>
      <option value="bug">Bug</option>
      <option value="rock">Rock</option>
      <option value="ghost">Ghost</option>
      <option value="dragon">Dragon</option>
      <option value="dark">Dark</option>
      <option value="steel">Steel</option>
      <option value="fairy">Fairy</option>
    </select>

    <br /><br />

    <label for="evolution">Evolution Stage:</label>
    <select id="evolution" name="evo">
      <option value="">--Any--</option>
      <option value="0">Basic (no pre-evolution)</option>
      <option value="1">Stage 1 (1 pre-evolution)</option>
      <option value="2">Stage 2 (2 pre-evolutions)</option>
    </select>

    <br /><br />
    <button type="submit">Search</button>
  </form>

  <div id="loading" class="loading" style="display:none;">Loading, please wait...</div>

  <div id="result"></div>

  <script>
    // Helper: fetch JSON from a URL
    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to fetch ${url}`);
      return res.json();
    }

    // Get evolution chain depth for a Pokémon species
    async function getEvolutionStage(speciesUrl) {
      const speciesData = await fetchJSON(speciesUrl);
      const evoChainUrl = speciesData.evolution_chain.url;
      const evoData = await fetchJSON(evoChainUrl);

      // Find this species in the evolution chain and calculate depth
      function findSpecies(chain, targetName, depth = 0) {
        if (chain.species.name === targetName) return depth;
        for (const evo of chain.evolves_to) {
          const d = findSpecies(evo, targetName, depth + 1);
          if (d !== -1) return d;
        }
        return -1;
      }

      return findSpecies(evoData.chain, speciesData.name);
    }

    // Main function triggered by form submit
    async function searchPokemon(event) {
      event.preventDefault();
      const loadingDiv = document.getElementById('loading');
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';
      loadingDiv.style.display = 'block';

      const typeFilter = document.getElementById('poke-type').value;
      const evoFilter = document.getElementById('evolution').value;

      try {
        // We'll check the first 151 Pokémon for demo purposes (you can increase this)
        const limit = 151;
        let filteredPokemon = [];

        // Loop through Pokémon IDs
        for (let id = 1; id <= limit; id++) {
          try {
            const pokeData = await fetchJSON(`https://pokeapi.co/api/v2/pokemon/${id}`);

            // Filter by type
            if (typeFilter) {
              const types = pokeData.types.map(t => t.type.name);
              if (!types.includes(typeFilter)) continue;
            }

            // Fetch species and check evolution stage if filter applied
            if (evoFilter !== '') {
              const speciesUrl = pokeData.species.url;
              const evoStage = await getEvolutionStage(speciesUrl);
              if (evoStage.toString() !== evoFilter) continue;
            }

            // Add to filtered list
            filteredPokemon.push({
              name: pokeData.name,
              sprite: pokeData.sprites.front_default,
              types: pokeData.types.map(t => t.type.name).join(', '),
              id: pokeData.id,
            });

          } catch (err) {
            console.warn(`Failed to fetch Pokémon ID ${id}`, err);
          }
        }

        if (filteredPokemon.length === 0) {
          resultDiv.innerHTML = '<p>No Pokémon matched your filters.</p>';
          return;
        }

        // Pick a random Pokémon from filtered list
        const chosen = filteredPokemon[Math.floor(Math.random() * filteredPokemon.length)];

        // Show result
        resultDiv.innerHTML = `
          <h2>${chosen.name.charAt(0).toUpperCase() + chosen.name.slice(1)} (#${chosen.id})</h2>
          <img src="${chosen.sprite}" alt="${chosen.name}" />
          <p><strong>Type(s):</strong> ${chosen.types}</p>
        `;

      } catch (error) {
        resultDiv.innerHTML = `<p>Error: ${error.message}</p>`;
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Attach event listener
    document.getElementById('search-form').addEventListener('submit', searchPokemon);
  </script>

</body>
</html>
